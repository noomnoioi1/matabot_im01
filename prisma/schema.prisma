generator client {
  provider = "prisma-client"
}

datasource db {
  provider = "postgresql"
}

enum ImageStorage {
  R2
  S3
  MINIO
  LOCAL
}

model User {
  id        String   @id @default(cuid())
  email     String?  @unique
  username  String   @unique
  displayName String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  decks     Deck[]
  imports   ImportBatch[]
}

model CardSet {
  id          String   @id @default(cuid())
  code        String   @unique
  nameTh      String?
  nameEn      String?
  releaseDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  printings   CardPrinting[]
}

model CardType {
  id        String   @id @default(cuid())
  code      String   @unique
  nameTh    String
  nameEn    String?
  createdAt DateTime @default(now())

  cards     Card[]
}

model Rarity {
  id        String   @id @default(cuid())
  code      String   @unique
  nameTh    String
  nameEn    String?
  createdAt DateTime @default(now())

  printings CardPrinting[]
}

model Card {
  id          String   @id @default(cuid())
  nameTh      String
  nameEn      String?
  description String?
  typeId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  type        CardType @relation(fields: [typeId], references: [id])
  printings   CardPrinting[]
}

model CardPrinting {
  id          String   @id @default(cuid())
  cardId      String
  setId       String
  rarityId    String?
  printCode   String?  @unique        // เช่น SD01-001
  setNumber   String?                 // เช่น 001
  artist      String?
  hp          Int?
  cost        Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  card        Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  set         CardSet  @relation(fields: [setId], references: [id])
  rarity      Rarity?  @relation(fields: [rarityId], references: [id])

  images      CardImage[]
  deckCards   DeckCard[]

  @@index([cardId])
  @@index([setId])
  @@index([rarityId])
  @@unique([setId, setNumber, rarityId]) // กันซ้ำตาม set/เลข/rare (ปรับได้)
}

model CardImage {
  id          String       @id @default(cuid())
  printingId  String
  storage     ImageStorage @default(R2)
  objectKey   String?      // path/key ใน bucket
  url         String?      // public url (ถ้ามี)
  width       Int?
  height      Int?
  checksum    String?      // กันซ้ำ/ตรวจไฟล์
  createdAt   DateTime @default(now())

  printing    CardPrinting @relation(fields: [printingId], references: [id], onDelete: Cascade)

  @@index([printingId])
}

model Deck {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  cards       DeckCard[]

  @@index([userId])
}

model DeckCard {
  id          String   @id @default(cuid())
  deckId      String
  printingId  String
  qty         Int      @default(1)

  deck        Deck        @relation(fields: [deckId], references: [id], onDelete: Cascade)
  printing    CardPrinting @relation(fields: [printingId], references: [id])

  @@unique([deckId, printingId])
  @@index([printingId])
}

model ImportBatch {
  id          String   @id @default(cuid())
  userId      String?
  source      String?  // เช่น "xlsx:cards_SD01.xlsx"
  note        String?
  startedAt   DateTime @default(now())
  finishedAt  DateTime?
  status      String   @default("RUNNING") // RUNNING|DONE|FAILED
  error       String?

  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
}
