// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

//
// ===== Enums =====
//
enum ImportJobStatus {
  queued
  running
  success
  failed
  partial
}

enum ImportRowStatus {
  pending
  mapped
  inserted
  updated
  skipped
  error
}

enum AssetSource {
  upload
  xlsx_embedded
  url
  s3
  r2
  minio
}

//
// ===== Domain: Card =====
//
model CardSet {
  id          String         @id @default(uuid()) @db.Uuid
  code        String         @unique @db.VarChar(20)
  nameTh      String?        @db.VarChar(255)
  nameEn      String?        @db.VarChar(255)
  releaseDate DateTime?      @db.Date
  createdAt   DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime       @updatedAt @db.Timestamptz(6)

  printings   CardPrinting[]

  @@map("card_set")
}

model CardType {
  id          String        @id @default(uuid()) @db.Uuid
  code        String        @unique @db.VarChar(30) // AVATAR/SPELL/ITEM...
  nameTh      String        @db.VarChar(100)
  nameEn      String        @db.VarChar(100)
  description String?
  sortOrder   Int           @default(0)
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime      @updatedAt @db.Timestamptz(6)

  subtypes    CardSubtype[]
  cards       Card[]

  @@map("card_type")
}

model CardSubtype {
  id         String   @id @default(uuid()) @db.Uuid
  cardTypeId String   @db.Uuid
  code       String   @db.VarChar(30)
  nameTh     String?  @db.VarChar(100)
  nameEn     String?  @db.VarChar(100)
  sortOrder  Int      @default(0)

  cardType   CardType @relation(fields: [cardTypeId], references: [id], onDelete: Cascade)
  cards      Card[]

  @@unique([cardTypeId, code])
  @@index([cardTypeId])
  @@map("card_subtype")
}

model Card {
  id           String        @id @default(uuid()) @db.Uuid
  nameTh       String        @db.VarChar(255)
  nameEn       String?       @db.VarChar(255)

  cardTypeId   String        @db.Uuid
  cardSubtypeId String?      @db.Uuid

  cost         Int?
  gem          Int?
  power        Int?
  symbol       String?       @db.VarChar(50)
  color        String?       @db.VarChar(50)
  exText       String?
  mainEffect   String?
  alley        Int?

  createdAt    DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime      @updatedAt @db.Timestamptz(6)

  cardType     CardType      @relation(fields: [cardTypeId], references: [id], onDelete: Restrict)
  cardSubtype  CardSubtype?  @relation(fields: [cardSubtypeId], references: [id], onDelete: SetNull)

  printings    CardPrinting[]
  images       CardImage[]

  @@index([cardTypeId])
  @@index([cardSubtypeId])
  @@map("card")
}

model CardPrinting {
  id         String   @id @default(uuid()) @db.Uuid
  cardId     String   @db.Uuid
  setId      String?  @db.Uuid

  printCode  String   @db.VarChar(50) // SD01-001
  rarity     String?  @db.VarChar(20)
  dropRate   String?  @db.VarChar(50)

  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)

  card       Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)
  set        CardSet?  @relation(fields: [setId], references: [id], onDelete: SetNull)
  images     CardImage[]

  @@unique([printCode])
  @@unique([setId, printCode])
  @@index([cardId])
  @@index([setId])
  @@map("card_printing")
}

//
// ===== Media / Images =====
//
model MediaAsset {
  id           String      @id @default(uuid()) @db.Uuid
  source       AssetSource
  bucket       String?     @db.VarChar(255)
  objectKey    String?
  publicUrl    String?
  originalName String?
  mimeType     String?     @db.VarChar(120)
  byteSize     BigInt?
  width        Int?
  height       Int?
  sha256       String?     @db.Char(64)
  createdAt    DateTime    @default(now()) @db.Timestamptz(6)

  cardImages   CardImage[]
  rowAssets    ImportRowAsset[]

  @@unique([sha256])
  @@map("media_asset")
}

model CardImage {
  id         String     @id @default(uuid()) @db.Uuid
  cardId     String     @db.Uuid
  printingId String?    @db.Uuid
  assetId    String     @db.Uuid

  imageRole  String     @default("front") @db.VarChar(30) // front/back/alt/icon
  sortOrder  Int        @default(0)
  isPrimary  Boolean    @default(false)

  createdAt  DateTime   @default(now()) @db.Timestamptz(6)

  card       Card       @relation(fields: [cardId], references: [id], onDelete: Cascade)
  printing   CardPrinting? @relation(fields: [printingId], references: [id], onDelete: Cascade)
  asset      MediaAsset @relation(fields: [assetId], references: [id], onDelete: Restrict)

  @@unique([cardId, printingId, assetId, imageRole])
  @@index([cardId])
  @@index([printingId])
  @@index([assetId])
  @@map("card_image")
}

//
// ===== Import Pipeline =====
//
model ImportFile {
  id            String      @id @default(uuid()) @db.Uuid
  filename      String
  fileType      String      @default("xlsx") @db.VarChar(20)
  storageSource AssetSource @default(upload)
  bucket        String?     @db.VarChar(255)
  objectKey     String?
  sha256        String?     @db.Char(64)
  byteSize      BigInt?
  createdBy     String?     @db.Uuid
  createdAt     DateTime    @default(now()) @db.Timestamptz(6)

  jobs          ImportJob[]

  @@unique([sha256])
  @@map("import_file")
}

model ImportJob {
  id           String         @id @default(uuid()) @db.Uuid
  importFileId String         @db.Uuid
  status       ImportJobStatus @default(queued)

  startedAt    DateTime?      @db.Timestamptz(6)
  finishedAt   DateTime?      @db.Timestamptz(6)

  totalRows    Int            @default(0)
  successRows  Int            @default(0)
  errorRows    Int            @default(0)

  settings     Json           @default("{}")

  createdAt    DateTime       @default(now()) @db.Timestamptz(6)

  importFile   ImportFile     @relation(fields: [importFileId], references: [id], onDelete: Cascade)
  rows         ImportRow[]
  errors       ImportErrorLog[]

  @@index([importFileId])
  @@map("import_job")
}

model ImportRow {
  id            String        @id @default(uuid()) @db.Uuid
  jobId         String        @db.Uuid
  rowNo         Int
  sheetName     String?       @db.VarChar(120)

  rawData       Json
  status        ImportRowStatus @default(pending)
  message       String?

  mappedCardId     String?     @db.Uuid
  mappedPrintingId String?     @db.Uuid

  createdAt     DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime      @updatedAt @db.Timestamptz(6)

  job           ImportJob     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  assets        ImportRowAsset[]
  errorLogs     ImportErrorLog[]

  @@unique([jobId, rowNo])
  @@index([jobId, status])
  @@map("import_row")
}

model ImportRowAsset {
  id           String      @id @default(uuid()) @db.Uuid
  importRowId  String      @db.Uuid

  kind         String      @default("image") @db.VarChar(30)
  source       AssetSource @default(xlsx_embedded)

  embeddedBytes Bytes?
  embeddedMime  String?    @db.VarChar(120)
  embeddedName  String?
  sha256        String?    @db.Char(64)

  assetId       String?    @db.Uuid
  createdAt     DateTime   @default(now()) @db.Timestamptz(6)

  importRow     ImportRow   @relation(fields: [importRowId], references: [id], onDelete: Cascade)
  asset         MediaAsset? @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@index([importRowId])
  @@index([assetId])
  @@map("import_row_asset")
}

model ImportErrorLog {
  id           String    @id @default(uuid()) @db.Uuid
  jobId        String    @db.Uuid
  importRowId  String?   @db.Uuid

  errorCode    String?   @db.VarChar(50)
  errorDetail  String
  debug        Json      @default("{}")
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)

  job          ImportJob @relation(fields: [jobId], references: [id], onDelete: Cascade)
  row          ImportRow? @relation(fields: [importRowId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@index([importRowId])
  @@map("import_error_log")
}
